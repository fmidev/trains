version: '3'
services:
  get_as_csv:
    volumes:
      - ~:/root:ro
      - ~/trains:/a
    environment:
      PYTHONUNBUFFERED: 1
    image: tervo/ml:cpu
    command: python -u bin/get_as_csv.py --dataset ${DATASET:-trains-10d-sample} --type ${TYPE:-feature} --starttime 2018-01-07 --endtime 2018-01-08
#############
  create_db:
    image: tervo/ml:cpu
    command: python -u bin/ml_feature_db/db/create_db.py --force --logging_level DEBUG
    volumes:
      - ~:/root:ro
      - ~/trains:/a
    environment:
      PYTHONUNBUFFERED: 1
#############
  add_stations:
    image: tervo/ml:cpu
    command: python -u bin/add_locations.py --logging_level DEBUG --filename data/stations.json
    volumes:
      - ~:/root:ro
      - ~/trains:/a
    environment:
      PYTHONUNBUFFERED: 1
#############
  labels_from_csv:
    image: tervo/ml:cpu
    command: python -u bin/labels_from_csv.py --logging_level INFO --filename ${LABEL_FILE:-data/subset/a_b_nayte.csv} --dataset ${DATASET:-trains-10d-sample} --job_count 10
    volumes:
      - ~:/root:ro
      - ~/trains:/a
#############
  remove_dataset:
    image: tervo/ml:cpu
    command: python -u bin/remove_dataset.py --logging_level INFO --labels --features --dataset ${DATASET:-trains-10d-sample}
    volumes:
      - ~:/root:ro
      - ~/trains:/a
    environment:
      PYTHONUNBUFFERED: 1
#############
  get_observations:
    image: tervo/ml:cpu
    command: python -u bin/get_observations.py --dataset ${DATASET:-trains-10d-sample} --producer opendata --starttime ${STARTTIME:-2018-01-01} --endtime ${ENDTIME:-2018-01-10} --job_count ${JOBS:-10} --logging_level ${LOGGING:-INFO}
    volumes:
      - ~:/root:ro
      - ~/trains:/a
#############
  get_observations_batch:
    image: tervo/ml:cpu
    command: python -u bin/get_observations_batch.py --dataset ${DATASET:-trains-1.0} --producer fmi --starttime ${STARTTIME:-2018-01-01} --endtime ${ENDTIME:-2018-01-10} --job_count ${JOBS:-4} --logging_level ${LOGGING:-INFO}
    volumes:
      - ~:/root:ro
      - ~/trains:/a
#############
  copy_dataset:
    image: tervo/ml:cpu
    command: python -u bin/copy_dataset.py --src_dataset ${SRC_DATASET:-trains-1.0} --dst_dataset ${DST_DATASET:-trains-1.2} --starttime ${STARTTIME:-2010-01-01} --endtime ${ENDTIME:-2013-01-10} --src_parameters ${SRC_PARAMETERS:-cnf/parameters.txt} --dst_parameters ${DST_PARAMETERS:-cnf/parameters_shorten.txt} --logging_level ${LOGGING:-INFO}
    volumes:
      - ~:/root:ro
      - ~/trains:/a
#############
  fixprec:
    image: tervo/ml:cpu
    command: python -u bin/fix_precipitation_sum.py --dataset ${DATASET:-prectest} --starttime ${STARTTIME:-2010-01-01} --endtime ${ENDTIME:-2010-01-02} --logging_level ${LOGGING:-INFO}
    volumes:
      - ~:/root:ro
      - ~/trains:/a
#############
  pgtobq:
    volumes:
      - ~:/root:ro
      - ~/trains:/a
      - /tmp:/tmp
    environment:
      - GOOGLE_APPLICATION_CREDENTIALS=/a/cnf/TRAINS-full.json
      #- HTTPS_PROXY=wwwproxy.fmi.fi:8080
    image: tervo/ml:cpu
    command: python -u bin/m.py --starttime ${STARTTIME:-2010-01-01} --endtime ${ENDTIME:-2018-01-10} --logging_level ${LOGGING:-DEBUG}
#############
  rfr:
    volumes:
      - ~:/root:ro
      - ~/trains:/a
      - /tmp:/tmp
    environment:
      - GOOGLE_APPLICATION_CREDENTIALS=/a/cnf/TRAINS-full.json
    image: tervo/ml:cpu
    command: python -u bin/train_scikit.py --starttime ${STARTTIME:-2010-01-01} --endtime ${ENDTIME:-2015-12-31} --logging_level ${LOGGING:-INFO} --model ${MODEL:-rf} --feature_dataset ${FEATURE_DATASET:-trains_2011_14} --day_step 2190
#############
  lrdev:
    volumes:
      - ~:/root:ro
      - ~/trains:/a
      - /tmp:/tmp
    environment:
      - GOOGLE_APPLICATION_CREDENTIALS=/a/cnf/TRAINS-full.json
      - HTTPS_PROXY=wwwproxy.fmi.fi:8080
    image: tervo/ml:cpu
    command: python -u bin/train.py --starttime ${STARTTIME:-2010-01-01} --endtime ${ENDTIME:-2010-01-10} --logging_level ${LOGGING:-INFO} --dev ${DEV:-1} --feature_dataset ${FEATURE_DATASET:-trains_1y_dev} --label_dataset ${LABEL_DATASET:-trains_labels} --model ${MODEL:-rf}
#############
  scikit_dev:
    volumes:
      - ~:/root:ro
      - ~/trains:/a
      - /tmp:/tmp
    environment:
      - GOOGLE_APPLICATION_CREDENTIALS=/a/cnf/TRAINS-full.json
    #  - HTTPS_PROXY=wwwproxy.fmi.fi:8080
    image: tervo/ml:cpu
    command: python -u bin/train_scikit.py --starttime ${STARTTIME:-2010-01-01} --endtime ${ENDTIME:-2010-01-10} --logging_level ${LOGGING:-INFO} --dev ${DEV:-1} --feature_dataset ${FEATURE_DATASET:-trains_1y_dev} --label_dataset ${LABEL_DATASET:-trains_labels} --model ${MODEL:-rf} --day_step ${DAY_STEP:-30}
#############
  vizperf:
    volumes:
      - ~:/root:ro
      - ~/trains:/a
      - /tmp:/tmp
    environment:
      - GOOGLE_APPLICATION_CREDENTIALS=/a/cnf/TRAINS-full.json
      - HTTPS_PROXY=wwwproxy.fmi.fi:8080
    image: tervo/ml:cpu
    command: python -u bin/viz_performance.py --logging_level ${LOGGING:-INFO} --feature_dataset ${FEATURE_DATASET:-trains_1y_dev} --model_path ${MODEL_PATH:-models/trains_1y_dev/serving/1530189858} --stations TKL,SAV #,VS
############
  vizperf_scikit:
    volumes:
      - ~:/root:ro
      - ~/trains:/a
      - /tmp:/tmp
    environment:
      - GOOGLE_APPLICATION_CREDENTIALS=/a/cnf/TRAINS-full.json
      - HTTPS_PROXY=wwwproxy.fmi.fi:8080
    image: tervo/ml:cpu
    command: python -u bin/viz_performance.py --logging_level ${LOGGING:-INFO} --feature_dataset ${FEATURE_DATASET:-trains_1y_dev} --model_file ${MODEL_PATH:-models/rf/trains_1y_dev/model.pkl} --stations TKL,SAV #,VS
#############
  clean_db:
    volumes:
      - ~:/root:ro
      - ~/trains:/a
    image: tervo/ml:cpu_local
    command: python -u bin/clean_duplicates.py --dataset ${DATASET:-trains-10d-sample} --logging_leve ${LOGGING:-INFO} --count 29
#############
  moddev:
    volumes:
      - ~:/root:ro
      - ~/trains:/a
      - /tmp:/tmp
    image: tervo/ml:cpu
    command: python -u bin/lr.py --dataset ${DATASET:-trains-tiny-subset} --starttime ${STARTTIME:-2018-01-01} --endtime ${ENDTIME:-2018-01-10} --logging_level ${LOGGING:-DEBUG} --save_path /tmp/moddev/model --output_path /tmp/moddev/results
#############
  vis:
    volumes:
      - ~:/root:ro
      - ~/trains:/a
    image: tervo/ml:cpu
    command: python -u bin/visualize_data.py --dataset ${DATASET:-trains-10d-sample} --starttime ${STARTTIME:-2018-01-01} --endtime ${ENDTIME:-2018-01-10} --logging_level ${LOGGING:-INFO} --save_path labels_vis_1_0 --what ${WHAT:-histograms,history}
#############
  board:
    volumes:
      - /tmp:/tmp
    ports:
      - "80:6006"
    image: tensorflow/tensorflow
    command: tensorboard --logdir=/tmp/lr --host 0.0.0.0
#############
  pred:
    environment:
      - GOOGLE_APPLICATION_CREDENTIALS=/a/cnf/TRAINS-e3a33a82c833.json
    image: docker.weatherproof.fi:5000/trains-prediction:1.2
    command: python -u bin/get_prediction.py --logging_level ${LOGGING:-INFO} --dev ${DEV:-1}
